{% extends 'templates/erp/layout.twig' %}

{% block title %}{{ parent() }} - Novo Agendamento{% endblock %}

{% set getCustomerAutocomplete = { 'URL': 'ERP\\Cadastre\\Entities\\Autocompletion\\Get', 'method': 'PATCH' } %}
{% set getVehicleCompletion      = { 'URL': 'ERP\\Cadastre\\Vehicles\\Autocompletion\\Get', 'method': 'PATCH' } %}

{% block stylesheets %}
  {{ parent() }}
  {{ css('libs/jquery/plugins/autocomplete/autocomplete.min.css') }}
  {{ css('libs/semantic-ui/components/calendar.min.css') }}
  
  <style>
    /* Estilos para o formulário de agendamentos */
    .ui.form .fields .field .ui.calendar {
      width: 100%;
    }
    
    /* Seções do formulário */
    .section-block {
      margin-bottom: 2em;
      padding: 1.5em;
    }
    
    .section-block:last-of-type {
      margin-bottom: 1em;
    }
    
    /* Blocos de detalhes */
    .details-block {
      margin-top: 1em;
      padding: 1em;
      background-color: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: .28571429rem;
      display: none;
    }
    
    .details-block.active {
      display: block;
    }
    
    .details-block h4 {
      margin-top: 0;
      color: #2185d0;
      font-size: 1em;
    }
    
    .details-block p {
      margin-bottom: 0.5em;
      font-size: 0.95em;
    }
    
    /* Autocomplete customizations */
    .ui.search .results .result {
      padding: 0.85714286em 1.14285714em;
    }
    
    .ui.search .results .result .content .title {
      font-weight: bold;
      color: #1e70bf;
      font-size: 1.1em;
    }
    
    .ui.search .results .result .content .description {
      margin-top: 0.3em;
      color: #767676;
      font-size: 0.9em;
    }
    
    /* Estados do formulário */
    .field.error .ui.dropdown,
    .field.error .ui.input input,
    .field.error input,
    .field.error textarea,
    .field.error select {
      background: #fff6f6;
      border-color: #e0b4b4;
      color: #9f3a38;
    }
    
    .helper {
      color: #9f3a38;
      font-size: 0.92857143em;
      margin-top: 0.25em;
      display: block;
    }
    
    /* Mensagens informativas */
    .ui.info.message {
      background-color: #f8ffff;
    }
    
    /* Dropdown de técnicos */
    .technician-item .description {
      color: #767676;
      font-size: 0.9em;
    }
    
    .technician-item .text {
      font-weight: 500;
    }
    
    .technician-location {
      font-style: italic;
      color: #2185d0;
    }
    
    /* Seção oculta */
    .hidden-section {
      display: none !important;
    }
    
    /* Loading */
    .loading-overlay {
      position: relative;
    }
    
    .loading-overlay.loading::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      z-index: 1000;
    }
  </style>
{% endblock %}

{% block content %}
<div class="ui main basic segment">
  <h2 class="ui blue header">
    <i class="calendar plus outline icon"></i>
    <div class="content">
      Novo Agendamento
      <div class="sub header">Preencha os dados para criar um novo agendamento técnico</div>
    </div>
  </h2>

  {# Mensagens de erro gerais #}
  {% if hasError('general') %}
    <div class="ui error message transition visible">
      <i class="close icon"></i>
      <div class="header">Erro</div>
      <p>{{ getError('general') }}</p>
    </div>
  {% endif %}

  <form class="ui form" id="appointmentForm" method="POST" action="{{ path_for('ERP\\Appointments\\Add') }}" autocomplete="off">
    {{ csrf.field | raw }}
    <input type="hidden" name="_method" value="POST">
    
    {# Campos ocultos para dados selecionados #}
    <input type="hidden" name="customer_id" id="customer_id" value="{{ getValue('customer_id') }}">
    <input type="hidden" name="subsidiary_id" id="subsidiary_id" value="{{ getValue('subsidiary_id') }}">

    {# SEÇÃO 1: Identificação do Cliente #}
    <div class="ui segment section-block">
      <h3 class="ui dividing header">
        <i class="user icon"></i>
        Identificação do Cliente
      </h3>
      
      <div class="field required{{ cssError('customer_name') }}">
        <label>Nome do Cliente</label>
        <div class="ui search" id="customer_search">
          <div class="ui icon input">
            <input class="prompt" type="text" name="customer_name" id="customer_name" 
                   placeholder="Digite o nome do cliente..." 
                   value="{{ getValue('customer_name') }}" 
                   autocomplete="off">
            <i class="search icon"></i>
          </div>
          <div class="results"></div>
        </div>
        {% if hasError('customer_name') %}
          <small class="helper">{{ getError('customer_name') }}</small>
        {% endif %}
      </div>
      
      {# Bloco de detalhes do cliente selecionado #}
      <div class="details-block" id="customer_details">
        <h4><i class="info circle icon"></i>Cliente Selecionado</h4>
        <div class="ui relaxed list">
          <div class="item">
            <i class="user icon"></i>
            <div class="content">
              <strong id="customer_name_display">Nome do Cliente</strong>
              <div class="description">
                <span id="customer_document_display">Documento</span>
              </div>
            </div>
          </div>
          <div class="item">
            <i class="building icon"></i>
            <div class="content">
              <strong id="customer_subsidiary_display">Unidade/Filial</strong>
              <div class="description">
                <span id="customer_address_display">Endereço</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    {# SEÇÃO 2: Identificação do Veículo #}
{# SEÇÃO 2: Identificação do Veículo #}
<div class="ui segment section-block">
  <h3 class="ui dividing header">
    <i class="car icon"></i>
    Identificação do Veículo
  </h3>
  
  <div class="field required{{ cssError('plate') }}">
    <label>Placa do Veículo</label>
    <!-- MUDANÇA: Usar ui search como no cliente -->
    <div class="ui search" id="plate_search">
      <div class="ui icon input">
        <input class="prompt" 
               type="text" 
               name="plate" 
               id="plate" 
               placeholder="Digite a placa do veículo..." 
               value="{{ getValue('plate') }}"
               autocomplete="off">
        <i class="search icon"></i>
      </div>
      <div class="results"></div>
    </div>
    
    <!-- Campo oculto para ID do veículo -->
    <input type="hidden" 
           name="plateid" 
           id="plateid"
           value="{{ getValue('plateid') }}">
    
    {% if hasError('plate') %}
      <small class="helper">{{ getError('plate') }}</small>
    {% endif %}
  </div>
  
  <!-- Container para mensagem/detalhes -->
  <div id="vehicle_info_container"></div>
</div>

    {# SEÇÃO 3: Tipo de Serviço #}
    <div class="ui segment section-block">
      <h3 class="ui dividing header">
        <i class="wrench icon"></i>
        Tipo de Serviço
      </h3>
      
      <div class="field required{{ cssError('service_type') }}">
        <label>Serviço a ser Realizado</label>
        <select name="service_type" id="service_type" class="ui dropdown">
          <option value="">Selecione o tipo de serviço</option>
          <option value="installation" {% if getValue('service_type') == 'installation' %}selected{% endif %}>Instalação de Rastreador</option>
          <option value="maintenance" {% if getValue('service_type') == 'maintenance' %}selected{% endif %}>Manutenção</option>
          <option value="repair" {% if getValue('service_type') == 'repair' %}selected{% endif %}>Reparo</option>
          <option value="removal" {% if getValue('service_type') == 'removal' %}selected{% endif %}>Retirada de Equipamento</option>
          <option value="inspection" {% if getValue('service_type') == 'inspection' %}selected{% endif %}>Inspeção/Vistoria</option>
          <option value="emergency" {% if getValue('service_type') == 'emergency' %}selected{% endif %}>Emergência</option>
        </select>
        {% if hasError('service_type') %}
          <small class="helper">{{ getError('service_type') }}</small>
        {% endif %}
      </div>
    </div>

    {# SEÇÃO 4: Data e Hora #}
    <div class="ui segment section-block">
      <h3 class="ui dividing header">
        <i class="calendar icon"></i>
        Data e Hora do Atendimento
      </h3>
      
      <div class="two fields">
        <div class="field required{{ cssError('scheduled_date') }}">
          <label>Data do Agendamento</label>
          <div class="ui calendar" id="schedule_calendar">
            <div class="ui input left icon">
              <i class="calendar icon"></i>
              <input type="text" name="scheduled_date" id="scheduled_date" 
                     placeholder="DD/MM/AAAA" 
                     value="{{ getValue('scheduled_date') }}">
            </div>
          </div>
          {% if hasError('scheduled_date') %}
            <small class="helper">{{ getError('scheduled_date') }}</small>
          {% endif %}
        </div>
        
        <div class="field required{{ cssError('scheduled_time') }}">
          <label>Horário</label>
          <select name="scheduled_time" id="scheduled_time" class="ui dropdown">
            <option value="">Selecione o horário</option>
            {% set current_time = getValue('scheduled_time') %}
            {% for hour in 8..18 %}
              {% for minute in ['00', '30'] %}
                {% if not (hour == 12 and minute == '30') %}
                  {% set time_val = '%02d:%s'|format(hour, minute) %}
                  <option value="{{ time_val }}" {% if current_time == time_val %}selected{% endif %}>{{ time_val }}</option>
                {% endif %}
              {% endfor %}
            {% endfor %}
          </select>
          {% if hasError('scheduled_time') %}
            <small class="helper">{{ getError('scheduled_time') }}</small>
          {% endif %}
        </div>
      </div>
      
      {# Campo oculto para datetime combinado #}
      <input type="hidden" name="scheduled_at" id="scheduled_at" value="{{ getValue('scheduled_at') }}">
    </div>

    {# SEÇÃO 5: Técnico Responsável #}
    <div class="ui segment section-block">
      <h3 class="ui dividing header">
        <i class="user tie icon"></i>
        Técnico Responsável
      </h3>
      
      <div class="field required{{ cssError('technician_id') }}">
        <label>Técnico</label>
        <div class="ui fluid selection dropdown">
          <input name="technician_id" type="hidden" value="{{ getValue('technician_id') }}">
          <i class="dropdown icon"></i>
          <div class="default text">Escolha um técnico...</div>
          <div class="menu">
            {% set technicianID = getValue('technician_id') %}
            {% for technician in technicians %}
              <div class="item technician-item" 
                   {% if technician.value == technicianID %}selected{% endif %}
                   data-value="{{ technician.value }}">
                <span class="description">
                  <span class="technician-location">{{ technician.city }}/{{ technician.state }}</span>
                  {% if technician.description %}
                    <br>{{ technician.description }}
                  {% endif %}
                </span>
                <span class="text">{{ technician.name }}</span>
              </div>
            {% endfor %}
          </div>
        </div>
        {% if hasError('technician_id') %}
          <small class="helper">{{ getError('technician_id') }}</small>
        {% endif %}
      </div>
    </div>

    {# SEÇÃO 6: Local do Atendimento #}
    <div class="ui segment section-block">
      <h3 class="ui dividing header">
        <i class="map marker icon"></i>
        Local do Atendimento
      </h3>
      
      <div class="field required{{ cssError('service_address') }}">
        <label>Endereço</label>
        <div class="ui input">
          <input type="text" name="service_address" id="service_address" 
                 placeholder="Rua, Av..." 
                 value="{{ getValue('service_address') }}">
        </div>
        {% if hasError('service_address') %}
          <small class="helper">{{ getError('service_address') }}</small>
        {% endif %}
      </div>
      
      <div class="three fields">
        <div class="field{{ cssError('service_number') }}">
          <label>Número</label>
          <div class="ui input">
            <input type="text" name="service_number" id="service_number" 
                   placeholder="123" 
                   value="{{ getValue('service_number') }}">
          </div>
          {% if hasError('service_number') %}
            <small class="helper">{{ getError('service_number') }}</small>
          {% endif %}
        </div>
        
        <div class="field{{ cssError('service_district') }}">
          <label>Bairro</label>
          <div class="ui input">
            <input type="text" name="service_district" id="service_district" 
                   placeholder="Centro" 
                   value="{{ getValue('service_district') }}">
          </div>
          {% if hasError('service_district') %}
            <small class="helper">{{ getError('service_district') }}</small>
          {% endif %}
        </div>
        
        <div class="field{{ cssError('service_city') }}">
          <label>Cidade</label>
          <div class="ui input">
            <input type="text" name="service_city" id="service_city" 
                   placeholder="São Paulo" 
                   value="{{ getValue('service_city') }}">
          </div>
          {% if hasError('service_city') %}
            <small class="helper">{{ getError('service_city') }}</small>
          {% endif %}
        </div>
      </div>
    </div>

    {# SEÇÃO 7: Observações #}
    <div class="ui segment section-block">
      <h3 class="ui dividing header">
        <i class="sticky note icon"></i>
        Observações Adicionais
      </h3>
      
      <div class="field{{ cssError('notes') }}">
        <label>Observações</label>
        <textarea name="notes" id="notes" rows="3" 
                  placeholder="Informações adicionais sobre o agendamento...">{{ getValue('notes') }}</textarea>
        {% if hasError('notes') %}
          <small class="helper">{{ getError('notes') }}</small>
        {% endif %}
      </div>
      
      <div class="field">
        <div class="ui checkbox">
          <input type="checkbox" name="is_emergency" id="is_emergency" value="1" {% if getValue('is_emergency') %}checked{% endif %}>
          <label>Agendamento de emergência (prioridade alta)</label>
        </div>
      </div>
    </div>

    {# Botões de ação #}
    <div class="ui hidden divider"></div>
    
    <div class="field">
      <button type="submit" class="ui large green fluid button" id="save_button">
        <i class="save icon"></i> Salvar Agendamento
      </button>
    </div>
    
    <div class="field">
      <a href="{{ path_for('ERP\\Appointments\\Calendar') }}" class="ui large fluid button">
        <i class="cancel icon"></i> Cancelar
      </a>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
  {{ parent() }}
  {{ lib('semantic-ui/components/calendar.min.js') }}
  {{ lib('jquery/plugins/autocomplete/autocomplete.min.js') }}
  
  {% set getCustomerAutocomplete = { 'URL': 'ERP\\Cadastre\\Entities\\Autocompletion\\Get', 'method': 'PATCH' } %}
  {% set getVehicleCompletion      = { 'URL': 'ERP\\Cadastre\\Vehicles\\Autocompletion\\Get', 'method': 'PATCH' } %}
  
  <script>
    // ========================================
// SUBSTITUIR TODO O BLOCO <script> DO add.twig
// ========================================

$(document).ready(function() {
    // Inicializar componentes Semantic UI
    $('.ui.dropdown').dropdown();
    $('.ui.checkbox').checkbox();
    
    // ========================================
    // CONFIGURAÇÃO DO AUTOCOMPLETE DE PLACA
    // ========================================
    
    // Variável para controlar se cliente foi selecionado
    var customerSelected = false;
    var currentCustomerId = $('#customer_id').val();

    // Variável para controlar estado
    var vehicleSearchEnabled = false;
    
    // Se já tem cliente selecionado (edit mode)
    if (currentCustomerId && currentCustomerId !== '') {
        customerSelected = true;
        enablePlateField();
    } else {
        disablePlateField();
    }
    
    // Função para desabilitar campo de placa
    function disablePlateField() {
        $('#plate').prop('disabled', true)
                   .attr('placeholder', 'Selecione um cliente primeiro...')
                   .css('background-color', '#f0f0f0');
        
        // Adicionar mensagem informativa
        if (!$('#plate_info_message').length) {
            $('#plate').parent().after(
                '<div id="plate_info_message" class="ui info message">' +
                '<i class="info circle icon"></i>' +
                'Selecione um cliente para habilitar a busca de veículos' +
                '</div>'
            );
        }
    }
    
    // Função para habilitar campo de placa
    function enablePlateField() {
        $('#plate').prop('disabled', false)
                   .attr('placeholder', 'Digite a placa do veículo...')
                   .css('background-color', '');
        
        // Remover mensagem informativa
        $('#plate_info_message').remove();
        
        // Inicializar autocomplete de placa
        initializePlateAutocomplete();
    }
    
    // Função para inicializar autocomplete de placa
   function initializePlateAutocomplete() {
    // Usar Semantic UI Search
    $('#plate_search').search({
      loading: {
        duration: 200
    },
    // Adicionar classe loading durante busca
    onSearchQuery: function(query) {
        $(this).addClass('loading');
    },
    onResults: function() {
        $(this).removeClass('loading');
    }
        apiSettings: {
            url: "{{ path_for(getVehicleCompletion.URL) }}",
            method: "{{ getVehicleCompletion.method }}",
            beforeSend: function(settings) {
                var customerId = $('#customer_id').val();
                var searchTerm = settings.urlData.query;
                
                // DEBUG COMPLETO
                console.log('=== DEBUG AUTOCOMPLETE PLACA ===');
                console.log('Cliente ID:', customerId);
                console.log('Termo de busca:', searchTerm);
                console.log('URL:', settings.url);
                console.log('Method:', settings.type);
                
                // Tentar diferentes formatos de parâmetros
                settings.data = {
                    searchTerm: searchTerm,
                    customerID: customerId,
                    // Tente adicionar estes parâmetros extras
                    subsidiaryID: $('#subsidiary_id').val(), // Adicionar subsidiary
                    type: 'vehicle',
                    detailed: true,
                    limit: 20,
                    // Parâmetros alternativos que a API pode esperar
                    query: searchTerm,  // Alguns endpoints usam 'query'
                    term: searchTerm,   // Outros usam 'term'
                    search: searchTerm  // Ou 'search'
                };
                
                console.log('Dados enviados:', settings.data);
                console.log('=== FIM DEBUG ===');
                
                return settings;
            },
            onResponse: function(response) {
                console.log('=== RESPOSTA DO SERVIDOR ===');
                console.log('Resposta completa:', response);
                
                var results = { results: [] };
                
                // Se não houver dados, adicionar mensagem personalizada
                if (response && response.result === 'OK') {
                    if (response.data && response.data.length > 0) {
                        $.each(response.data, function(index, vehicle) {
                            console.log('Veículo ' + index + ':', vehicle);
                            
                            var statusLabel = vehicle.inuse 
                                ? '<span style="color: darkred; font-style: italic;"> (rastreado)</span>'
                                : '<span style="color: #9cadcd; font-style: italic;"> (sem rastreador)</span>';
                            
                            var blockedLabel = vehicle.blocked 
                                ? ' - <span style="color: #8b0000; font-style: italic;">Bloqueado</span>'
                                : '';
                            
                            var description = 
                                '<div style="color: #0256C4; font-style: italic;">' + 
                                vehicle.brand + ' / ' + vehicle.model + '</div>' +
                                '<div>Cor: <span style="color: CornflowerBlue;">' + 
                                vehicle.color + '</span>' + blockedLabel + '</div>';
                            
                            results.results.push({
                                title: vehicle.plate + statusLabel,
                                description: description,
                                vehicle_data: vehicle
                            });
                        });
                    } else {
                        // DEBUG: Verificar se há veículos para este cliente
                        console.log('⚠️ Nenhum veículo encontrado para o termo:', settings.urlData.query);
                        console.log('Cliente ID usado:', $('#customer_id').val());
                        
                        // Mensagem customizada
                        results.message = {
                            type: 'empty',
                            header: 'Nenhum veículo encontrado',
                            description: 'Tente digitar mais caracteres ou verifique a placa'
                        };
                    }
                }
                
                return results;
            }
        },
        minCharacters: 1,  // Reduzir para 1 para teste
        searchOnFocus: false,
        cache: false,
        maxResults: 20,
        searchDelay: 300,  // Adicionar delay
        // Configuração para mostrar mensagem quando vazio
        error: {
            noResults: 'Nenhum veículo encontrado para este cliente'
        },
        onSelect: function(result, response) {
    if (result && result.vehicle_data) {
        var vehicle = result.vehicle_data;
        
        console.log('✅ Veículo selecionado:', vehicle);
        
        // Preencher campos - garantir que os IDs estão corretos
        $('#plate').val(vehicle.plate);
        $('#plateid').val(vehicle.id);
        
        // Verificar se os valores foram preenchidos
        console.log('Placa preenchida:', $('#plate').val());
        console.log('ID do veículo preenchido:', $('#plateid').val());
        
        // Mostrar detalhes
        showVehicleDetails(vehicle);
        
        // Fechar o dropdown de busca
        $('#plate_search').search('hide results');
    }
    return false;
}
    });
    
    // Monitorar limpeza manual
    $('#plate').on('input', function() {
        if (!$(this).val() || $(this).val().trim() === '') {
            $('#plateid').val('');
            hideVehicleDetails();
        }
    });
}
    
    // Função para mostrar detalhes do veículo (estava faltando!)
function showVehicleDetails(vehicle) {
    console.log('Mostrando detalhes do veículo:', vehicle);
    
    // Criar HTML dos detalhes
    var statusText = vehicle.inuse ? 'Com rastreador' : 'Sem rastreador';
    var statusClass = vehicle.inuse ? 'green' : 'grey';
    var blockedText = vehicle.blocked ? '<span class="ui red label">Bloqueado</span>' : '';
    
    var detailsHtml = 
        '<div class="details-block active" id="vehicle_details">' +
        '  <h4><i class="car icon"></i>Veículo Selecionado</h4>' +
        '  <div class="ui relaxed list">' +
        '    <div class="item">' +
        '      <i class="car icon"></i>' +
        '      <div class="content">' +
        '        <strong>' + vehicle.plate + '</strong> ' +
        '        <span class="ui ' + statusClass + ' label">' + statusText + '</span> ' + 
        blockedText +
        '        <div class="description">' +
        '          <strong>Modelo:</strong> ' + vehicle.brand + ' ' + vehicle.model + '<br>' +
        '          <strong>Cor:</strong> ' + vehicle.color + '<br>' +
        '          <strong>Tipo:</strong> ' + vehicle.type +
        '        </div>' +
        '      </div>' +
        '    </div>' +
        '  </div>' +
        '</div>';
    
    // Remover detalhes anteriores se existir
    $('#vehicle_details').remove();
    
    // Adicionar no container correto
    $('#vehicle_info_container').html(detailsHtml);
}

// Função para esconder detalhes do veículo
function hideVehicleDetails() {
    console.log('Escondendo detalhes do veículo');
    $('#vehicle_details').remove();
    $('#vehicle_info_container').empty();
}
  
    
    // ========================================
    // CONFIGURAÇÃO DO AUTOCOMPLETE DE CLIENTE
    // ========================================
    
    $('#customer_search').search({
        apiSettings: {
            url: '{{ path_for(getCustomerAutocomplete.URL) }}',
            method: '{{ getCustomerAutocomplete.method }}',
            beforeSend: function(settings) {
                settings.data = {
                    searchTerm: settings.urlData.query,
                    type: 'customer',
                    detailed: true,
                    notIncludeAnyRegister: true,
                    limit: 10
                };
                return settings;
            },
            onResponse: function(response) {
                var results = { results: [] };
                
                if (response && response.result === 'OK' && response.data) {
                    $.each(response.data, function(index, customer) {
                        var description = '';
                        if (customer.juridicalperson) {
                            description = customer.subsidiaryname + ' | ' + customer.type;
                        } else {
                            description = (customer.headoffice ? 'Titular' : 'Dependente: ' + customer.subsidiaryname);
                        }
                        
                        results.results.push({
                            title: customer.name,
                            description: description,
                            customer_data: customer
                        });
                    });
                }
                
                return results;
            }
        },
        autoSelectFirst: true,
            searchOnFocus: false,
            cache: false,
            maxResults: 20,
            minChars: 2,
            preventBadQueries: false,
        onSelect: function(result, response) {
            if (result && result.customer_data) {
                var customer = result.customer_data;
                
                // Preencher campos ocultos
                $('#customer_id').val(customer.id);
                $('#subsidiary_id').val(customer.subsidiaryid);
                
                // Manter o nome no campo
                $('#customer_name').val(customer.name);
                
                // IMPORTANTE: Habilitar campo de placa após selecionar cliente
                customerSelected = true;
                currentCustomerId = customer.id;
                enablePlateField();
                
                // Limpar seleção anterior de veículo
                $('#plate').val('');
                $("input[name='plateid']").val('');
                hideVehicleDetails();
                
                // Exibir detalhes do cliente
                $('#customer_name_display').text(customer.name);
                $('#customer_subsidiary_display').text(customer.subsidiaryname);
                
                // Buscar dados completos do cliente
                $.ajax({
                    url: '{{ path_for(getCustomerAutocomplete.URL) }}',
                    method: '{{ getCustomerAutocomplete.method }}',
                    data: {
                        type: 'ownerdata',
                        customerID: customer.id,
                        subsidiaryID: customer.subsidiaryid
                    },
                    success: function(response) {
                        if (response.result === 'OK' && response.data) {
                            var ownerData = response.data;
                            
                            $('#customer_document_display').text(ownerData.nationalregister || 'Não informado');
                            
                            var address = ownerData.address || '';
                            if (ownerData.streetnumber) address += ', ' + ownerData.streetnumber;
                            if (ownerData.complement) address += ' - ' + ownerData.complement;
                            if (ownerData.district) address += ' - ' + ownerData.district;
                            if (ownerData.cityname) address += ', ' + ownerData.cityname;
                            if (ownerData.state) address += '/' + ownerData.state;
                            
                            $('#customer_address_display').text(address || 'Endereço não informado');
                            
                            // Auto-preencher endereço de atendimento (se vazio)
                            if (!$('#service_address').val() && ownerData.address) {
                                $('#service_address').val(ownerData.address);
                                $('#service_number').val(ownerData.streetnumber || '');
                                $('#service_district').val(ownerData.district || '');
                                $('#service_city').val(ownerData.cityname || '');
                            }
                        }
                    }
                });
                
                $('#customer_details').addClass('active');
            }
            return false;
        }
    });
    
    // ========================================
    // CONFIGURAÇÃO DO CALENDÁRIO
    // ========================================
    
    $('#schedule_calendar').calendar({
        type: 'date',
        monthFirst: false,
        today: true,
        minDate: new Date(),
        formatter: { 
            date: function (date, settings) { 
                if (!date) return ''; 
                var day = date.getDate(); 
                var month = date.getMonth() + 1; 
                var year = date.getFullYear(); 
                return (day < 10 ? '0' : '') + day + '/' + 
                       (month < 10 ? '0' : '') + month + '/' + year; 
            }
        }
    });
    
    // ========================================
    // EVENTOS DO FORMULÁRIO
    // ========================================
    
    // Monitorar mudanças manuais no campo cliente
    $('#customer_name').on('input', function() {
        var value = $(this).val();
        
        // Se o campo foi limpo manualmente
        if (!value || value.trim() === '') {
            // Resetar seleção de cliente
            $('#customer_id').val('');
            $('#subsidiary_id').val('');
            $('#customer_details').removeClass('active');
            
            // Desabilitar campo de placa
            customerSelected = false;
            currentCustomerId = '';
            disablePlateField();
            
            // Limpar veículo
            $('#plate').val('');
            $("input[name='plateid']").val('');
            hideVehicleDetails();
        }
    });
    
    // Validação antes do submit
    $('#appointmentForm').on('submit', function(e) {
        var date = $('#scheduled_date').val();
        var time = $('#scheduled_time').val();
        
        // Validar se cliente foi selecionado
        if (!$('#customer_id').val()) {
            e.preventDefault();
            alert('Por favor, selecione um cliente válido.');
            $('#customer_name').focus();
            return false;
        }
        
        // Validar se veículo foi selecionado
        if (!$("input[name='plateid']").val() && $('#plate').val()) {
            e.preventDefault();
            alert('Por favor, selecione um veículo válido da lista.');
            $('#plate').focus();
            return false;
        }
        
        // Combinar data e hora
        if (date && time) {
            var dateParts = date.split('/');
            if (dateParts.length === 3) {
                var datetime = dateParts[2] + '-' + dateParts[1] + '-' + 
                              dateParts[0] + ' ' + time + ':00';
                $('#scheduled_at').val(datetime);
            }
        }
        
        // Adicionar loading ao botão
        $('#save_button').addClass('loading').prop('disabled', true);
    });
    
    // Fechar mensagens
    $('.ui.message .close.icon').on('click', function() {
        $(this).closest('.message').transition('fade');
    });
    
    // ========================================
    // ESTILOS ADICIONAIS PARA AUTOCOMPLETE
    // ========================================
    
    // Adicionar estilos CSS dinamicamente para melhorar visual do autocomplete
    if (!$('#autocomplete_styles').length) {
        $('head').append(
            '<style id="autocomplete_styles">' +
            '.autocomplete-results {' +
            '  max-height: 300px;' +
            '  overflow-y: auto;' +
            '  border: 1px solid #d4d4d5;' +
            '  border-radius: .28571429rem;' +
            '  background: white;' +
            '  box-shadow: 0 2px 4px 0 rgba(34,36,38,.12), 0 2px 10px 0 rgba(34,36,38,.15);' +
            '}' +
            '.autocomplete-result {' +
            '  padding: 10px;' +
            '  border-bottom: 1px solid #f0f0f0;' +
            '  cursor: pointer;' +
            '}' +
            '.autocomplete-result:hover {' +
            '  background-color: #f9fafb;' +
            '}' +
            '.autocomplete-result .plate-info {' +
            '  font-size: 1.1em;' +
            '  margin-bottom: 5px;' +
            '}' +
            '.autocomplete-result .vehicle-details {' +
            '  font-size: 0.9em;' +
            '  color: #767676;' +
            '}' +
            '</style>'
        );
    }
    
    console.log('Sistema de autocomplete inicializado com sucesso!');
});


  </script>
{% endblock %}