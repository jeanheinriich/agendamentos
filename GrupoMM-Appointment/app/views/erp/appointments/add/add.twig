{% extends 'templates/erp/layout.twig' %}

{% block title %}{{ parent() }} - Novo Agendamento{% endblock %}

{% set getCustomerAutocomplete = { 'URL': 'ERP\\Cadastre\\Entities\\Autocompletion\\Get', 'method': 'PATCH' } %}
{% set getVehicleCompletion      = { 'URL': 'ERP\\Cadastre\\Vehicles\\Autocompletion\\Get', 'method': 'PATCH' } %}

{% block stylesheets %}
  {{ parent() }}
  {{ css('libs/jquery/plugins/autocomplete/autocomplete.min.css') }}
  {{ css('libs/semantic-ui/components/calendar.min.css') }}
  
  <style>
    /* Estilos para o formulário de agendamentos */
    .ui.form .fields .field .ui.calendar {
      width: 100%;
    }
    
    /* Seções do formulário */
    .section-block {
      margin-bottom: 2em;
      padding: 1.5em;
    }
    
    .section-block:last-of-type {
      margin-bottom: 1em;
    }
    
    /* Blocos de detalhes */
    .details-block {
      margin-top: 1em;
      padding: 1em;
      background-color: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: .28571429rem;
      display: none;
    }
    
    .details-block.active {
      display: block;
    }
    
    .details-block h4 {
      margin-top: 0;
      color: #2185d0;
      font-size: 1em;
    }
    
    .details-block p {
      margin-bottom: 0.5em;
      font-size: 0.95em;
    }
    
    /* Autocomplete customizations */
    .ui.search .results .result {
      padding: 0.85714286em 1.14285714em;
    }
    
    .ui.search .results .result .content .title {
      font-weight: bold;
      color: #1e70bf;
      font-size: 1.1em;
    }
    
    .ui.search .results .result .content .description {
      margin-top: 0.3em;
      color: #767676;
      font-size: 0.9em;
    }
    
    /* Estados do formulário */
    .field.error .ui.dropdown,
    .field.error .ui.input input,
    .field.error input,
    .field.error textarea,
    .field.error select {
      background: #fff6f6;
      border-color: #e0b4b4;
      color: #9f3a38;
    }
    
    .helper {
      color: #9f3a38;
      font-size: 0.92857143em;
      margin-top: 0.25em;
      display: block;
    }
    
    /* Mensagens informativas */
    .ui.info.message {
      background-color: #f8ffff;
    }
    
    /* Dropdown de técnicos */
    .technician-item .description {
      color: #767676;
      font-size: 0.9em;
    }
    
    .technician-item .text {
      font-weight: 500;
    }
    
    .technician-location {
      font-style: italic;
      color: #2185d0;
    }
    
    /* Seção oculta */
    .hidden-section {
      display: none !important;
    }
    
    /* Loading */
    .loading-overlay {
      position: relative;
    }
    
    .loading-overlay.loading::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      z-index: 1000;
    }
    
    /* MELHORIAS UX: Estilo do ícone dropdown */
    .ui.search.dropdown-style .icon {
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    
    .ui.search.dropdown-style .icon:hover {
      color: #2185d0;
    }
    
    /* Rotação do ícone quando dropdown aberto */
    .ui.search.dropdown-style.active .icon.dropdown {
      transform: rotate(180deg);
    }
    
    /* Cursor pointer para campos clicáveis */
    .ui.search.dropdown-style input {
      cursor: pointer;
    }
    
    /* Melhor visual para resultados vazios */
    .ui.search > .results .message {
      padding: 1em;
      font-size: 1em;
      color: #767676;
    }
    
    /* Estilos para dropdown de serviços */
    #service_type optgroup {
      font-weight: bold;
      color: #2185d0;
    }
    
    #service_type option {
      padding-left: 20px;
    }
    
    #service_type option.emergency-highlight {
      background-color: #fff5f5;
      color: #d01919 !important;
      font-weight: bold;
    }
    
    .ui.dropdown.disabled {
      opacity: 0.45;
      cursor: not-allowed;
    }
    
    /* Mensagem de informação do serviço */
    #service_info_message {
      margin-top: 1em;
      background-color: #f8ffff !important;
      border: 1px solid #b5d3e7;
    }
    
    /* Estilos para seleção de endereços */
    #address_options_list .segment {
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }
    
    #address_options_list .segment:hover {
      background-color: #f8f9fa;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    #address_options_list .segment.selected {
      background-color: #e8f4fd;
      border-left: 3px solid #2185d0;
    }
    
    .address-radio {
      margin-right: 10px;
    }
    
    .address-main-badge {
      display: inline-block;
      background: #2185d0;
      color: white;
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 0.85em;
      margin-left: 10px;
    }
    
    .address-place {
      font-weight: bold;
      color: #2185d0;
      margin-bottom: 5px;
    }
    
    .address-details {
      color: #666;
      font-size: 0.95em;
      line-height: 1.5;
    }
    
    .address-phones {
      margin-top: 5px;
      font-size: 0.9em;
      color: #888;
    }
    
    #manual_address_form {
      transition: all 0.3s ease;
    }
    
    #manual_address_form.hidden {
      display: none;
    }
    
    .new-address-option {
      background-color: #f8ffff !important;
      border: 2px dashed #2185d0 !important;
    }
    
    .new-address-option:hover {
      background-color: #e8f4fd !important;
    }
    
    .new-address-option .icon {
      color: #2185d0;
    }
    
    /* Estilos para autocomplete de CEP */
    .ui.input.loading input {
      background-image: url('data:image/gif;base64,R0lGODlhEAAQAPIAAP///wAAAMLCwkJCQgAAAGJiYoKCgpKSkiH/C05FVFNDQVBFMi4wAwEAAAAh/hpDcmVhdGVkIHdpdGggYWpheGxvYWQuaW5mbwAh+QQJCgAAACwAAAAAEAAQAAADMwi63P4wyklrE2MIOggZnAdOmGYJRbExwroUmcG2LmDEwnHQLVsYOd2mBzkYDAdKa+dIAAAh+QQJCgAAACwAAAAAEAAQAAADNAi63P5OjCEgG4QMu7DmikRxQlFUYDEZIGBMRVsaqHwctXXf7WEYB4Ag1xjihkMZsiUkKhIAIfkECQoAAAAsAAAAABAAEAAAAzYIujIjK8pByJDMlFYvBoVjHA70GU7xSUJhmKtwHPAKzLO9HMaoKwJZ7Rf8AYPDDzKpZBqfvwQAIfkECQoAAAAsAAAAABAAEAAAAzMIumIlK8oyhpHsnFZfhYumCYUhDAQxRIdhHBGqRoKw0R8DYlJd8z0fMDgsGo/IpHI5TAAAIfkECQoAAAAsAAAAABAAEAAAAzIIunInK0rnZBTwGPNMgQwmdsNgXGJUlIWEuR5oWUIpz8pAEAMe6TwfwyYsGo/IpFKSAAAh+QQJCgAAACwAAAAAEAAQAAADMwi6IMKQORfjdOe82p4wGccc4CEuQradylesojEMBgsUc2G7sDX3lQGBMLAJibufbSlKAAAh+QQJCgAAACwAAAAAEAAQAAADMgi63P7wCRHZnFVdmgHu2nFwlWCI3WGc3TSWhUFGxTAUkGCbtgENBMJAEJsxgMLWzpEAACH5BAkKAAAALAAAAAAQABAAAAMyCLrc/jDKSatlQtScKdceCAjDII7HcQ4EMTCpyrCuUBjCYRgHVtqlAiB1YhiCnlsRkAAAOwAAAAAAAAAAAA==');
      background-repeat: no-repeat;
      background-position: right 10px center;
      padding-right: 35px !important;
    }
    
    .field.success .ui.input input {
      background-color: #fcfff5 !important;
      border-color: #a3c293 !important;
      color: #2c662d !important;
      transition: all 0.3s ease;
    }
    
    #cep_message {
      animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    #search_cep_btn {
      margin-left: 10px;
    }
    
    .ui.input .info.circle.icon {
      cursor: help;
      opacity: 0.6;
      margin-left: 5px;
    }
    
    .ui.input .info.circle.icon:hover {
      opacity: 1;
    }
    
    /* Estilos para seleção de tipo de agendamento */
    #schedule_type_time.active,
    #schedule_type_period.active {
      background-color: #2185d0 !important;
      color: white !important;
    }
    
    #schedule_type_time:not(.active),
    #schedule_type_period:not(.active) {
      background-color: #f8f9fa !important;
      color: #666 !important;
    }
    
    .ui.two.buttons .button {
      transition: all 0.3s ease;
    }
    
    /* Estilos para os botões de ação */
    #cancel_button {
      background: white !important;
      border: 1px solid #d4d4d5 !important;
      color: #db2828 !important;
      font-weight: 500;
    }
    
    #cancel_button:hover {
      background: #fff8f8 !important;
      border-color: #db2828 !important;
    }
    
    #save_button {
      background-color: #2185d0 !important;
      color: white !important;
      font-weight: 500;
    }
    
    #save_button:hover {
      background-color: #1678c2 !important;
    }
    
    .ui.two.buttons {
      margin-top: 20px;
    }
    
    .ui.two.buttons .button {
      margin: 0 !important;
    }
  </style>
{% endblock %}

{% block content %}
<div class="ui main basic segment">
  <h2 class="ui blue header">
    <i class="calendar plus outline icon"></i>
    <div class="content">
      Novo Agendamento
      <div class="sub header">Preencha os dados para criar um novo agendamento técnico</div>
    </div>
  </h2>

  {# Mensagens de erro gerais #}
  {% if hasError('general') %}
    <div class="ui error message transition visible">
      <i class="close icon"></i>
      <div class="header">Erro</div>
      <p>{{ getError('general') }}</p>
    </div>
  {% endif %}

  <form class="ui form" id="appointmentForm" method="POST" action="{{ path_for('ERP\\Appointments\\Add') }}" autocomplete="off">
    {{ csrf.field | raw }}
    <input type="hidden" name="_method" value="POST">
    
    {# Campos ocultos para dados selecionados #}
    <input type="hidden" name="customer_id" id="customer_id" value="{{ getValue('customer_id') }}">
    <input type="hidden" name="subsidiary_id" id="subsidiary_id" value="{{ getValue('subsidiary_id') }}">

    {# SEÇÃO 1: Identificação do Cliente #}
    <div class="ui segment section-block">
      <h3 class="ui dividing header">
        <i class="user icon"></i>
        Identificação do Cliente
      </h3>
      
      <div class="field required{{ cssError('customer_name') }}">
        <label>Nome do Cliente</label>
        <div class="ui search dropdown-style" id="customer_search">
          <div class="ui icon input">
            <input class="prompt" type="text" name="customer_name" id="customer_name" 
                   placeholder="Digite o nome ou clique para ver clientes..." 
                   value="{{ getValue('customer_name') }}" 
                   autocomplete="off">
            <i class="dropdown icon"></i>
          </div>
          <div class="results"></div>
        </div>
        {% if hasError('customer_name') %}
          <small class="helper">{{ getError('customer_name') }}</small>
        {% endif %}
      </div>
      
      {# Bloco de detalhes do cliente selecionado #}
      <div class="details-block" id="customer_details">
        <h4><i class="info circle icon"></i>Cliente Selecionado</h4>
        <div class="ui relaxed list">
          <div class="item">
            <i class="user icon"></i>
            <div class="content">
              <strong id="customer_name_display">Nome do Cliente</strong>
              <div class="description">
                <span id="customer_document_display">Documento</span>
              </div>
            </div>
          </div>
          <div class="item">
            <i class="building icon"></i>
            <div class="content">
              <strong id="customer_subsidiary_display">Unidade/Filial</strong>
              <div class="description">
                <span id="customer_address_display">Endereço</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    {# SEÇÃO 2: Identificação do Veículo #}
    <div class="ui segment section-block">
      <h3 class="ui dividing header">
        <i class="car icon"></i>
        Identificação do Veículo
      </h3>
      
      <div class="field required{{ cssError('plate') }}">
        <label>Placa do Veículo</label>
        <div class="ui search dropdown-style" id="plate_search">
          <div class="ui icon input">
            <input class="prompt" 
                   type="text" 
                   name="plate" 
                   id="plate" 
                   placeholder="Clique para ver todos ou digite para filtrar..." 
                   value="{{ getValue('plate') }}"
                   autocomplete="off">
            <i class="dropdown icon"></i>
          </div>
          <div class="results"></div>
        </div>
        
        <!-- Campo oculto para ID do veículo -->
        <input type="hidden" 
               name="plateid" 
               id="plateid"
               value="{{ getValue('plateid') }}">
        
        {% if hasError('plate') %}
          <small class="helper">{{ getError('plate') }}</small>
        {% endif %}
      </div>
      
      <!-- Container para mensagem/detalhes -->
      <div id="vehicle_info_container"></div>
    </div>

    {# SEÇÃO 3: Tipo de Serviço #}
    <div class="ui segment section-block">
      <h3 class="ui dividing header">
        <i class="wrench icon"></i>
        Tipo de Serviço
      </h3>
      
      <div class="field required{{ cssError('service_type') }}">
        <label>Serviço a ser Realizado</label>
        <select name="service_type" id="service_type" class="ui dropdown">
          <option value="">Selecione primeiro um veículo para ver serviços disponíveis</option>
        </select>
        {% if hasError('service_type') %}
          <small class="helper">{{ getError('service_type') }}</small>
        {% endif %}
      </div>
      
      {# Mensagem informativa sobre o serviço selecionado #}
      <div id="service_info_message" class="ui info message" style="display: none;">
        <i class="info circle icon"></i>
        <span id="service_info_text"></span>
      </div>
    </div>

    {# SEÇÃO 4: Data e Hora #}
    <div class="ui segment section-block">
      <h3 class="ui dividing header">
        <i class="calendar icon"></i>
        Data e Hora do Atendimento
      </h3>
      
      <div class="field required{{ cssError('scheduled_date') }}">
        <label>Data do Agendamento</label>
        <div class="ui calendar" id="schedule_calendar">
          <div class="ui input left icon">
            <i class="calendar icon"></i>
            <input type="text" name="scheduled_date" id="scheduled_date" 
                   placeholder="DD/MM/AAAA" 
                   value="{{ getValue('scheduled_date') }}">
          </div>
        </div>
        {% if hasError('scheduled_date') %}
          <small class="helper">{{ getError('scheduled_date') }}</small>
        {% endif %}
      </div>
      
      {# Seleção de tipo de agendamento: Horário ou Período #}
      <div class="field">
        <label>Tipo de Agendamento</label>
        <div class="ui two buttons">
          <button type="button" class="ui button active" id="schedule_type_time">
            <i class="clock icon"></i>
            Horário Específico
          </button>
          <button type="button" class="ui button" id="schedule_type_period">
            <i class="sun icon"></i>
            Período
          </button>
        </div>
      </div>
      
      {# Container para horário específico #}
      <div class="field required{{ cssError('scheduled_time') }}" id="time_selection_container">
        <label>Horário</label>
        <select name="scheduled_time" id="scheduled_time" class="ui dropdown">
          <option value="">Selecione o horário</option>
          {% set current_time = getValue('scheduled_time') %}
          {% for hour in 8..18 %}
            {% for minute in ['00', '30'] %}
              {% if not (hour == 12 and minute == '30') %}
                {% set time_val = '%02d:%s'|format(hour, minute) %}
                <option value="{{ time_val }}" {% if current_time == time_val %}selected{% endif %}>{{ time_val }}</option>
              {% endif %}
            {% endfor %}
          {% endfor %}
        </select>
        {% if hasError('scheduled_time') %}
          <small class="helper">{{ getError('scheduled_time') }}</small>
        {% endif %}
      </div>
      
      {# Container para período #}
      <div class="field" id="period_selection_container" style="display: none;">
        <label>Período de Atendimento</label>
        <div class="ui selection dropdown" id="scheduled_period">
          <input type="hidden" name="scheduled_period" value="{{ getValue('scheduled_period') }}">
          <i class="dropdown icon"></i>
          <div class="default text">Selecione o período</div>
          <div class="menu">
            <div class="item" data-value="morning">
              <i class="sun icon" style="color: #f39c12;"></i>
              <span style="margin-left: 10px;">
                <strong>Manhã</strong> 
                <span style="color: #888; font-size: 0.9em;">(8h às 12h)</span>
              </span>
            </div>
            <div class="item" data-value="afternoon">
              <i class="sun outline icon" style="color: #e67e22;"></i>
              <span style="margin-left: 10px;">
                <strong>Tarde</strong>
                <span style="color: #888; font-size: 0.9em;">(13h às 17h)</span>
              </span>
            </div>
          </div>
        </div>
      </div>
      
      {# Campo oculto para datetime combinado #}
      <input type="hidden" name="scheduled_at" id="scheduled_at" value="{{ getValue('scheduled_at') }}">
      <input type="hidden" name="schedule_type" id="schedule_type" value="{{ getValue('schedule_type') ?: 'time' }}">
    </div>

    {# SEÇÃO 5: Técnico Responsável #}
    <div class="ui segment section-block">
      <h3 class="ui dividing header">
        <i class="user tie icon"></i>
        Técnico Responsável
      </h3>
      
      <div class="field required{{ cssError('technician_id') }}">
        <label>Técnico</label>
        <div class="ui fluid selection dropdown">
          <input name="technician_id" type="hidden" value="{{ getValue('technician_id') }}">
          <i class="dropdown icon"></i>
          <div class="default text">Escolha um técnico...</div>
          <div class="menu">
            {% set technicianID = getValue('technician_id') %}
            {% for technician in technicians %}
              <div class="item technician-item" 
                   {% if technician.value == technicianID %}selected{% endif %}
                   data-value="{{ technician.value }}">
                <span class="description">
                  <span class="technician-location">{{ technician.city }}/{{ technician.state }}</span>
                  {% if technician.description %}
                    <br>{{ technician.description }}
                  {% endif %}
                </span>
                <span class="text">{{ technician.name }}</span>
              </div>
            {% endfor %}
          </div>
        </div>
        {% if hasError('technician_id') %}
          <small class="helper">{{ getError('technician_id') }}</small>
        {% endif %}
      </div>
    </div>

    {# SEÇÃO 6: Local do Atendimento #}
    <div class="ui segment section-block">
      <h3 class="ui dividing header">
        <i class="map marker icon"></i>
        Local do Atendimento
      </h3>
      
      {# Container para seleção de endereços - aparece após selecionar veículo #}
      <div id="address_selection_container" style="display: none;">
        <div class="field">
          <label>Selecione o Endereço de Entrega</label>
          <div class="ui info message">
            <i class="info circle icon"></i>
            Escolha um endereço existente ou informe um novo local
          </div>
        </div>
        
        {# Lista de endereços disponíveis será preenchida via JavaScript #}
        <div class="field">
          <div id="address_options_list" class="ui segments">
            {# Endereços serão inseridos aqui dinamicamente #}
          </div>
        </div>
      </div>
      
      {# Formulário de endereço manual - sempre visível inicialmente, depois controlado por JS #}
      <div id="manual_address_form">
        <div class="two fields">
          <div class="field">
            <label>CEP <i class="info circle icon" style="opacity: 0.6;"></i></label>
            <div class="ui input">
              <input type="text" name="service_postalcode" id="service_postalcode" 
                     placeholder="00000-000" 
                     value="{{ getValue('service_postalcode') }}"
                     maxlength="9">
            </div>
            <div class="ui tiny basic button" id="search_cep_btn" style="margin-top: 5px; display: none;">
              <i class="search icon"></i>
              Buscar CEP
            </div>
          </div>
          
          <div class="field{{ cssError('service_number') }}">
            <label>Número <span style="color: red;">*</span></label>
            <div class="ui input">
              <input type="text" name="service_number" id="service_number" 
                     placeholder="123" 
                     value="{{ getValue('service_number') }}">
            </div>
            {% if hasError('service_number') %}
              <small class="helper">{{ getError('service_number') }}</small>
            {% endif %}
          </div>
        </div>
        
        <div class="field required{{ cssError('service_address') }}">
          <label>Endereço</label>
          <div class="ui input">
            <input type="text" name="service_address" id="service_address" 
                   placeholder="Rua, Av... (será preenchido automaticamente pelo CEP)" 
                   value="{{ getValue('service_address') }}">
          </div>
          {% if hasError('service_address') %}
            <small class="helper">{{ getError('service_address') }}</small>
          {% endif %}
        </div>
        
        <div class="two fields">
          <div class="field{{ cssError('service_district') }}">
            <label>Bairro</label>
            <div class="ui input">
              <input type="text" name="service_district" id="service_district" 
                     placeholder="Centro (será preenchido pelo CEP)" 
                     value="{{ getValue('service_district') }}">
            </div>
            {% if hasError('service_district') %}
              <small class="helper">{{ getError('service_district') }}</small>
            {% endif %}
          </div>
          
          <div class="field{{ cssError('service_city') }}">
            <label>Cidade</label>
            <div class="ui input">
              <input type="text" name="service_city" id="service_city" 
                     placeholder="São Paulo (será preenchido pelo CEP)" 
                     value="{{ getValue('service_city') }}">
            </div>
            {% if hasError('service_city') %}
              <small class="helper">{{ getError('service_city') }}</small>
            {% endif %}
          </div>
        </div>
        
        <div class="field">
          <label>Complemento</label>
          <div class="ui input">
            <input type="text" name="service_complement" id="service_complement" 
                   placeholder="Apto, Bloco, Sala, etc. (opcional)" 
                   value="{{ getValue('service_complement') }}">
          </div>
        </div>
      </div>
    </div>

    {# SEÇÃO 7: Observações #}
    <div class="ui segment section-block">
      <h3 class="ui dividing header">
        <i class="sticky note icon"></i>
        Observações Adicionais
      </h3>
      
      <div class="field{{ cssError('notes') }}">
        <label>Observações</label>
        <textarea name="notes" id="notes" rows="4" 
                  placeholder="Informações adicionais sobre o agendamento, referências do local, instruções especiais, etc.">{{ getValue('notes') }}</textarea>
        {% if hasError('notes') %}
          <small class="helper">{{ getError('notes') }}</small>
        {% endif %}
      </div>
    </div>

    {# Botões de ação #}
    <div class="ui hidden divider"></div>
    
    <div class="ui two buttons">
      <button type="button" class="ui large button" id="cancel_button" style="background: white; border: 1px solid #d4d4d5;">
        <span style="color: #db2828;">Cancelar</span>
      </button>
      <button type="submit" class="ui large primary button" id="save_button">
        Adicionar
      </button>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
  {{ parent() }}
  {{ lib('semantic-ui/components/calendar.min.js') }}
  {{ lib('jquery/plugins/autocomplete/autocomplete.min.js') }}
  
  {% set getCustomerAutocomplete = { 'URL': 'ERP\\Cadastre\\Entities\\Autocompletion\\Get', 'method': 'PATCH' } %}
  {% set getVehicleCompletion      = { 'URL': 'ERP\\Cadastre\\Vehicles\\Autocompletion\\Get', 'method': 'PATCH' } %}
  
  <script>
// ========================================
// MELHORIAS UX - AUTOCOMPLETES v2.0
// ========================================

$(document).ready(function() {
    // Inicializar componentes Semantic UI
    $('.ui.dropdown').dropdown();
    $('.ui.checkbox').checkbox();
    
    // Inicializar campo de tipo de serviço como desabilitado
    $('#service_type').parent().addClass('disabled');
    $('#service_type').dropdown('set text', 'Selecione primeiro um veículo');
    
    // ========================================
    // VARIÁVEIS GLOBAIS DE CONTROLE
    // ========================================
    
    var customerSelected = false;
    var currentCustomerId = $('#customer_id').val();
    var allVehicles = []; // Cache de todos os veículos do cliente
    var isSearching = false; // Flag para controlar busca em andamento
    
    // Se já tem cliente selecionado (edit mode)
    if (currentCustomerId && currentCustomerId !== '') {
        customerSelected = true;
        enablePlateField();
    } else {
        disablePlateField();
    }
    
    // ========================================
    // FUNÇÕES AUXILIARES
    // ========================================
    
    // Função para desabilitar campo de placa
    function disablePlateField() {
        $('#plate').prop('disabled', true)
                   .attr('placeholder', 'Selecione um cliente primeiro...')
                   .css('background-color', '#f0f0f0');
        
        // Adicionar mensagem informativa
        if (!$('#plate_info_message').length) {
            $('#plate').parent().after(
                '<div id="plate_info_message" class="ui info message">' +
                '<i class="info circle icon"></i>' +
                'Selecione um cliente para habilitar a busca de veículos' +
                '</div>'
            );
        }
    }
    
    // Função para habilitar campo de placa
    function enablePlateField() {
        $('#plate').prop('disabled', false)
                   .attr('placeholder', 'Clique para ver todos ou digite para filtrar...')
                   .css('background-color', '');
        
        // Remover mensagem informativa
        $('#plate_info_message').remove();
        
        // Inicializar autocomplete de placa
        initializePlateAutocomplete();
    }
    
    // Função para formatar veículo para exibição
    function formatVehicleResult(vehicle) {
        var statusLabel = vehicle.inuse 
            ? '<span style="color: darkred; font-style: italic;"> (rastreado)</span>'
            : '<span style="color: #9cadcd; font-style: italic;"> (sem rastreador)</span>';
        
        var blockedLabel = vehicle.blocked 
            ? ' - <span style="color: #8b0000; font-style: italic;">Bloqueado</span>'
            : '';
        
        var description = 
            '<div style="color: #0256C4; font-style: italic;">' + 
            vehicle.brand + ' / ' + vehicle.model + '</div>' +
            '<div>Cor: <span style="color: CornflowerBlue;">' + 
            vehicle.color + '</span>' + blockedLabel + '</div>';
        
        return {
            title: vehicle.plate + statusLabel,
            description: description,
            vehicle_data: vehicle
        };
    }
    
    // ========================================
    // CONFIGURAÇÃO DO AUTOCOMPLETE DE CLIENTE (MELHORADO)
    // ========================================
    
    $('#customer_search').search({
        apiSettings: {
            url: '{{ path_for(getCustomerAutocomplete.URL) }}',
            method: '{{ getCustomerAutocomplete.method }}',
            beforeSend: function(settings) {
                // MELHORIA: Busca sempre com o termo atual (não só 1 letra)
                settings.data = {
                    searchTerm: settings.urlData.query,
                    type: 'customer',
                    detailed: true,
                    notIncludeAnyRegister: true,
                    limit: 20 // Aumentar limite
                };
                return settings;
            },
            onResponse: function(response) {
                var results = { results: [] };
                
                if (response && response.result === 'OK' && response.data) {
                    $.each(response.data, function(index, customer) {
                        var description = '';
                        if (customer.juridicalperson) {
                            description = customer.subsidiaryname + ' | ' + customer.type;
                        } else {
                            description = (customer.headoffice ? 'Titular' : 'Dependente: ' + customer.subsidiaryname);
                        }
                        
                        results.results.push({
                            title: customer.name,
                            description: description,
                            customer_data: customer
                        });
                    });
                } else {
                    results.message = {
                        type: 'empty',
                        header: 'Nenhum cliente encontrado',
                        description: 'Tente com outro nome ou verifique a digitação'
                    };
                }
                
                return results;
            }
        },
        // MELHORIAS UX - CONFIGURAÇÕES
        minCharacters: 0, // MELHORIA: Permitir busca desde o primeiro caractere
        searchOnFocus: false, // Não buscar ao focar (comportamento padrão)
        cache: false, // Sem cache para sempre ter dados atualizados
        maxResults: 20,
        searchDelay: 200, // Delay menor para resposta mais rápida
        showNoResults: true, // Sempre mostrar mensagem quando não encontrar
        preserveHTML: true, // Preservar HTML nas respostas
        selectFirstResult: false, // Não selecionar automaticamente
        onSelect: function(result, response) {
            if (result && result.customer_data) {
                var customer = result.customer_data;
                
                // Preencher campos ocultos
                $('#customer_id').val(customer.id);
                $('#subsidiary_id').val(customer.subsidiaryid);
                
                // Manter o nome no campo
                $('#customer_name').val(customer.name);
                
                // Habilitar campo de placa
                customerSelected = true;
                currentCustomerId = customer.id;
                enablePlateField();
                
                // Limpar seleção anterior de veículo
                $('#plate').val('');
                $('#plateid').val('');
                hideVehicleDetails();
                allVehicles = []; // Limpar cache de veículos
                
                // Desabilitar e resetar tipos de serviço
                $('#service_type').parent().addClass('disabled');
                resetServiceTypes();
                
                // Exibir detalhes do cliente
                $('#customer_name_display').text(customer.name);
                $('#customer_subsidiary_display').text(customer.subsidiaryname);
                
                // Buscar dados completos do cliente
                $.ajax({
                    url: '{{ path_for(getCustomerAutocomplete.URL) }}',
                    method: '{{ getCustomerAutocomplete.method }}',
                    data: {
                        type: 'ownerdata',
                        customerID: customer.id,
                        subsidiaryID: customer.subsidiaryid
                    },
                    success: function(response) {
                        if (response.result === 'OK' && response.data) {
                            var ownerData = response.data;
                            
                            $('#customer_document_display').text(ownerData.nationalregister || 'Não informado');
                            
                            var address = ownerData.address || '';
                            if (ownerData.streetnumber) address += ', ' + ownerData.streetnumber;
                            if (ownerData.complement) address += ' - ' + ownerData.complement;
                            if (ownerData.district) address += ' - ' + ownerData.district;
                            if (ownerData.cityname) address += ', ' + ownerData.cityname;
                            if (ownerData.state) address += '/' + ownerData.state;
                            
                            $('#customer_address_display').text(address || 'Endereço não informado');
                            
                            // NÃO preencher mais automaticamente o endereço de atendimento
                            // Agora será controlado pela seleção de endereços após escolher o veículo
                        }
                    }
                });
                
                $('#customer_details').addClass('active');
            }
            return false;
        }
    });
    
    // ========================================
    // CONFIGURAÇÃO DO AUTOCOMPLETE DE PLACA (MELHORADO)
    // ========================================
    
    function initializePlateAutocomplete() {
        var plateSearch = $('#plate_search');
        var plateInput = $('#plate');
        
        // Configurar search do Semantic UI
        plateSearch.search({
            apiSettings: {
                url: "{{ path_for(getVehicleCompletion.URL) }}",
                method: "{{ getVehicleCompletion.method }}",
                beforeSend: function(settings) {
                    var customerId = $('#customer_id').val();
                    var searchTerm = settings.urlData.query || '';
                    
                    // Se não tem termo de busca (clicou no campo), buscar todos
                    if (!searchTerm || searchTerm.trim() === '') {
                        searchTerm = ' '; // Espaço para buscar todos
                    }
                    
                    settings.data = {
                        searchTerm: searchTerm,
                        customerID: customerId,
                        subsidiaryID: $('#subsidiary_id').val(),
                        type: 'vehicle',
                        detailed: true,
                        limit: 50 // Aumentar limite para mostrar todos
                    };
                    
                    console.log('Buscando veículos:', searchTerm);
                    isSearching = true;
                    return settings;
                },
                onResponse: function(response) {
                    isSearching = false;
                    var results = { results: [] };
                    
                    if (response && response.result === 'OK') {
                        if (response.data && response.data.length > 0) {
                            // Cachear todos os veículos
                            allVehicles = response.data;
                            
                            $.each(response.data, function(index, vehicle) {
                                results.results.push(formatVehicleResult(vehicle));
                            });
                        } else {
                            results.message = {
                                type: 'empty',
                                header: 'Nenhum veículo encontrado',
                                description: 'Este cliente não possui veículos cadastrados'
                            };
                        }
                    }
                    
                    return results;
                },
                onComplete: function() {
                    isSearching = false;
                }
            },
            // MELHORIAS UX - CONFIGURAÇÕES
            minCharacters: 0, // MELHORIA: Permitir busca desde o início
            searchOnFocus: true, // MELHORIA: Buscar ao focar (comportamento dropdown)
            cache: false,
            maxResults: 50,
            searchDelay: 100, // Delay menor para resposta mais rápida
            showNoResults: true,
            preserveHTML: true,
            selectFirstResult: false,
            // Configurar busca local (filtragem em tempo real)
            searchFields: ['title', 'description'],
            fullTextSearch: true, // MELHORIA: Busca em texto completo
            onSelect: function(result, response) {
                if (result && result.vehicle_data) {
                    var vehicle = result.vehicle_data;
                    
                    console.log('✅ Veículo selecionado:', vehicle);
                    
                    // Preencher campos
                    $('#plate').val(vehicle.plate);
                    $('#plateid').val(vehicle.id);
                    
                    // Mostrar detalhes
                    showVehicleDetails(vehicle);
                    
                    // Habilitar dropdown de serviços
                    $('#service_type').parent().removeClass('disabled');
                    
                    // Fechar o dropdown
                    plateSearch.search('hide results');
                }
                return false;
            }
        });
        
        // MELHORIA: Adicionar comportamento de clique para mostrar todos
        plateInput.on('focus', function() {
            if (!isSearching && customerSelected) {
                var currentVal = $(this).val();
                
                // Se o campo está vazio ou queremos mostrar todos
                if (!currentVal || currentVal.trim() === '') {
                    // Forçar busca de todos os veículos
                    plateSearch.search('query');
                    
                    // Se já temos veículos em cache, mostrar
                    if (allVehicles.length > 0) {
                        var results = { results: [] };
                        $.each(allVehicles, function(index, vehicle) {
                            results.results.push(formatVehicleResult(vehicle));
                        });
                        plateSearch.search('add results', results.results);
                        plateSearch.search('show results');
                    }
                }
            }
        });
        
        // MELHORIA: Adicionar animação ao ícone
        plateInput.on('focus', function() {
            plateSearch.addClass('active');
        }).on('blur', function() {
            setTimeout(function() {
                plateSearch.removeClass('active');
            }, 200);
        });
        
        // Monitorar limpeza manual
        plateInput.on('input', function() {
            var value = $(this).val();
            
            if (!value || value.trim() === '') {
                $('#plateid').val('');
                hideVehicleDetails();
                
                // Desabilitar dropdown de serviços
                $('#service_type').parent().addClass('disabled');
                resetServiceTypes();
                
                // Se limpar o campo, mostrar todos novamente ao próximo clique
                allVehicles = [];
            }
        });
        
        // MELHORIA: Permitir navegação com teclado
        plateInput.on('keydown', function(e) {
            if (e.key === 'ArrowDown' && !plateSearch.search('is visible')) {
                plateSearch.search('show results');
            }
        });
    }
    
    // Função para mostrar detalhes do veículo
    function showVehicleDetails(vehicle) {
        console.log('Mostrando detalhes do veículo:', vehicle);
        
        var statusText = vehicle.inuse ? 'Com rastreador' : 'Sem rastreador';
        var statusClass = vehicle.inuse ? 'green' : 'grey';
        var blockedText = vehicle.blocked ? '<span class="ui red label">Bloqueado</span>' : '';
        
        var detailsHtml = 
            '<div class="details-block active" id="vehicle_details">' +
            '  <h4><i class="car icon"></i>Veículo Selecionado</h4>' +
            '  <div class="ui relaxed list">' +
            '    <div class="item">' +
            '      <i class="car icon"></i>' +
            '      <div class="content">' +
            '        <strong>' + vehicle.plate + '</strong> ' +
            '        <span class="ui ' + statusClass + ' label">' + statusText + '</span> ' + 
            blockedText +
            '        <div class="description">' +
            '          <strong>Modelo:</strong> ' + vehicle.brand + ' ' + vehicle.model + '<br>' +
            '          <strong>Cor:</strong> ' + vehicle.color + '<br>' +
            '          <strong>Tipo:</strong> ' + vehicle.type +
            '        </div>' +
            '      </div>' +
            '    </div>' +
            '  </div>';
        
        // Se tem rastreador E temos os dados dos equipamentos
        if (vehicle.equipments && vehicle.equipments.length > 0) {
            detailsHtml += 
                '  <div class="ui divider"></div>' +
                '  <h4><i class="wifi icon"></i>Rastreador(es) Instalado(s)</h4>' +
                '  <div class="ui relaxed list">';
            
            vehicle.equipments.forEach(function(equipment) {
                var mainLabel = equipment.main ? 
                    '<span class="ui tiny blue label">Principal</span>' : 
                    '<span class="ui tiny grey label">Contingência</span>';
                
                var installedDate = 'Não informado';
                if (equipment.installedat) {
                    try {
                        var date = new Date(equipment.installedat);
                        installedDate = date.toLocaleDateString('pt-BR');
                    } catch(e) {
                        installedDate = equipment.installedat;
                    }
                }
                
                detailsHtml += 
                    '    <div class="item">' +
                    '      <i class="microchip icon"></i>' +
                    '      <div class="content">' +
                    '        <div class="header">' +
                    '          ' + (equipment.equipmentbrandname || 'Marca não informada') + ' ' + 
                                (equipment.equipmentmodelname || 'Modelo não informado') + ' ' + mainLabel +
                    '        </div>' +
                    '        <div class="description">';
                
                detailsHtml += '          <strong>Nº Série:</strong> ' + 
                              (equipment.serialnumber || 'Não informado') + '<br>';
                
                if (equipment.installationsite) {
                    detailsHtml += '          <strong>Local de Instalação:</strong> ' + 
                                  equipment.installationsite + '<br>';
                }
                
                var features = [];
                if (equipment.hasblocking === true || equipment.hasblocking === 't') {
                    var blockLocation = equipment.blockingsite ? ' (' + equipment.blockingsite + ')' : '';
                    features.push('<i class="lock icon"></i>Bloqueio' + blockLocation);
                }
                if (equipment.hasibutton === true || equipment.hasibutton === 't') {
                    var ibuttonLocation = equipment.ibuttonsite ? ' (' + equipment.ibuttonsite + ')' : '';
                    features.push('<i class="key icon"></i>iButton' + ibuttonLocation);
                }
                if (equipment.hassiren === true || equipment.hassiren === 't') {
                    var sirenLocation = equipment.sirensite ? ' (' + equipment.sirensite + ')' : '';
                    features.push('<i class="volume up icon"></i>Sirene' + sirenLocation);
                }
                if (equipment.panicbuttonsite) {
                    features.push('<i class="exclamation triangle icon"></i>Botão Pânico (' + 
                                 equipment.panicbuttonsite + ')');
                }
                
                if (features.length > 0) {
                    detailsHtml += '          <div class="ui small labels" style="margin-top: 5px;">';
                    features.forEach(function(feature) {
                        detailsHtml += '<div class="ui label">' + feature + '</div>';
                    });
                    detailsHtml += '          </div>';
                }
                
                detailsHtml += 
                    '          <div style="margin-top: 5px;">' +
                    '            <i class="calendar check icon"></i>' +
                    '            <strong>Instalado em:</strong> ' + installedDate +
                    '          </div>' +
                    '        </div>' +
                    '      </div>' +
                    '    </div>';
            });
            
            detailsHtml += '  </div>';
            
        } else if (vehicle.inuse) {
            detailsHtml += 
                '  <div class="ui divider"></div>' +
                '  <div class="ui info message">' +
                '    <i class="info circle icon"></i>' +
                '    Este veículo possui rastreador instalado' +
                '  </div>';
        } else {
            detailsHtml += 
                '  <div class="ui divider"></div>' +
                '  <div class="ui warning message">' +
                '    <i class="warning sign icon"></i>' +
                '    Este veículo não possui rastreador instalado' +
                '  </div>';
        }
        
        detailsHtml += '</div>';
        
        $('#vehicle_details').remove();
        $('#vehicle_info_container').html(detailsHtml);
        
        // IMPORTANTE: Atualizar tipos de serviço baseado no veículo
        updateServiceTypes(vehicle);
        
        // NOVO: Os endereços já vêm no objeto vehicle!
        if (vehicle.addresses && vehicle.addresses.length > 0) {
            console.log('Veículo tem ' + vehicle.addresses.length + ' endereços disponíveis');
            displayAddressOptions(vehicle.addresses);
        } else {
            console.log('Veículo não tem endereços cadastrados');
            $('#address_selection_container').hide();
            $('#manual_address_form').removeClass('hidden').show();
        }
    }
    
    // Função para esconder detalhes do veículo
    function hideVehicleDetails() {
        console.log('Escondendo detalhes do veículo');
        $('#vehicle_details').remove();
        $('#vehicle_info_container').empty();
        
        // Resetar tipos de serviço
        resetServiceTypes();
        
        // Resetar seleção de endereços
        resetAddressSelection();
    }
    
    // ========================================
    // GERENCIAMENTO DE ENDEREÇOS
    // ========================================
    
    // NÃO PRECISA MAIS da função loadVehicleAddresses pois os endereços já vêm no objeto!
    // Vamos direto para displayAddressOptions
    
    // Função para exibir opções de endereço
    function displayAddressOptions(addresses) {
        console.log('Exibindo ' + addresses.length + ' endereços disponíveis');
        
        // Mostrar container de seleção
        $('#address_selection_container').show();
        
        // Limpar lista
        var $list = $('#address_options_list');
        $list.empty();
        
        // Adicionar cada endereço como opção
        addresses.forEach(function(addr, index) {
            var isMain = addr.main === true || addr.main === 't';
            var addressId = 'address_option_' + index;
            
            // Formatar telefones
            var phonesHtml = '';
            if (addr.phones && addr.phones.length > 0) {
                var phoneNumbers = addr.phones.map(function(phone) {
                    return phone.phoneNumber || phone.phonenumber || phone.phoneTypeID;
                }).filter(function(phone) {
                    return phone;
                }).join(' | ');
                
                if (phoneNumbers) {
                    phonesHtml = '<div class="address-phones">' +
                                '<i class="phone icon"></i>' + phoneNumbers +
                                '</div>';
                }
            }
            
            // Montar endereço completo
            var fullAddress = addr.address || '';
            if (addr.streetNumber) fullAddress += ', ' + addr.streetNumber;
            if (addr.complement) fullAddress += ' - ' + addr.complement;
            if (addr.district) fullAddress += '<br>' + addr.district;
            if (addr.cityName && addr.state) {
                fullAddress += ', ' + addr.cityName + '/' + addr.state;
            }
            if (addr.postalCode) fullAddress += '<br>CEP: ' + addr.postalCode;
            
            var segmentHtml = 
                '<div class="ui segment" data-address-index="' + index + '">' +
                '  <div class="ui radio checkbox">' +
                '    <input type="radio" name="address_selection" id="' + addressId + '" ' +
                '           value="existing_' + index + '"' +
                '           data-address-data=\'' + JSON.stringify(addr).replace(/'/g, '&apos;') + '\'>' +
                '    <label for="' + addressId + '">' +
                '      <div class="address-place">' +
                '        ' + (addr.place || 'Endereço ' + (index + 1)) +
                (isMain ? '<span class="address-main-badge">Principal</span>' : '') +
                '      </div>' +
                '      <div class="address-details">' +
                '        ' + fullAddress +
                '      </div>' +
                       phonesHtml +
                '    </label>' +
                '  </div>' +
                '</div>';
            
            $list.append(segmentHtml);
        });
        
        // Adicionar opção de novo endereço
        var newAddressHtml = 
            '<div class="ui segment new-address-option" data-address-index="new">' +
            '  <div class="ui radio checkbox">' +
            '    <input type="radio" name="address_selection" id="address_option_new" value="new">' +
            '    <label for="address_option_new">' +
            '      <div class="address-place">' +
            '        <i class="plus circle icon"></i>' +
            '        Informar outro endereço' +
            '      </div>' +
            '      <div class="address-details">' +
            '        Clique aqui para informar um endereço diferente' +
            '      </div>' +
            '    </label>' +
            '  </div>' +
            '</div>';
        
        $list.append(newAddressHtml);
        
        // Inicializar radio buttons
        $('.ui.radio.checkbox').checkbox();
        
        // Selecionar o endereço principal por padrão
        var mainAddress = addresses.find(function(addr) {
            return addr.main === true || addr.main === 't';
        });
        
        if (mainAddress) {
            var mainIndex = addresses.indexOf(mainAddress);
            $('#address_option_' + mainIndex).prop('checked', true);
            $('[data-address-index="' + mainIndex + '"]').addClass('selected');
            
            // Preencher campos com endereço principal
            fillAddressFields(mainAddress);
            $('#manual_address_form').addClass('hidden');
        } else {
            // Se não tem endereço principal, seleciona o primeiro
            if (addresses.length > 0) {
                $('#address_option_0').prop('checked', true);
                $('[data-address-index="0"]').addClass('selected');
                fillAddressFields(addresses[0]);
                $('#manual_address_form').addClass('hidden');
            }
        }
        
        // Eventos de seleção
        $('input[name="address_selection"]').on('change', function() {
            var value = $(this).val();
            
            // Remover classe selected de todos
            $('.ui.segment', $list).removeClass('selected');
            
            // Adicionar classe selected ao selecionado
            $(this).closest('.ui.segment').addClass('selected');
            
            if (value === 'new') {
                // Mostrar formulário manual
                $('#manual_address_form').removeClass('hidden').show();
                clearAddressFields();
            } else {
                // Preencher com endereço selecionado
                var addressData = JSON.parse($(this).attr('data-address-data'));
                fillAddressFields(addressData);
                $('#manual_address_form').addClass('hidden');
            }
        });
        
        // Click direto no segment
        $('.ui.segment', $list).on('click', function(e) {
            if (!$(e.target).is('input')) {
                $(this).find('input[type="radio"]').prop('checked', true).trigger('change');
            }
        });
    }
    // Função para preencher campos de endereço
    function fillAddressFields(addressData) {
        console.log('Preenchendo campos com endereço:', addressData);
        
        $('#service_address').val(addressData.address || '');
        $('#service_number').val(addressData.streetNumber || '');
        $('#service_complement').val(addressData.complement || '');
        $('#service_district').val(addressData.district || '');
        $('#service_city').val(addressData.cityName || '');
        $('#service_postalcode').val(addressData.postalCode || '');
        
        // Se tiver cityID, pode ser útil armazenar
        if (addressData.cityID) {
            $('#service_address').attr('data-city-id', addressData.cityID);
        }
    }
    
    // Função para limpar campos de endereço
    function clearAddressFields() {
        console.log('Limpando campos de endereço');
        
        $('#service_address').val('');
        $('#service_number').val('');
        $('#service_complement').val('');
        $('#service_district').val('');
        $('#service_city').val('');
        $('#service_postalcode').val('');
        $('#service_address').removeAttr('data-city-id');
    }
    
    // Função para resetar seleção de endereços
    function resetAddressSelection() {
        console.log('Resetando seleção de endereços');
        
        $('#address_selection_container').hide();
        $('#address_options_list').empty();
        $('#manual_address_form').removeClass('hidden').show();
        clearAddressFields();
    }
    
    // Máscara para CEP
    $('#service_postalcode').on('input', function() {
        var value = $(this).val().replace(/\D/g, '');
        if (value.length > 5) {
            value = value.substring(0, 5) + '-' + value.substring(5, 8);
        }
        $(this).val(value);
        
        // NOVO: Busca CEP automaticamente quando completar 8 dígitos
        if (value.replace(/\D/g, '').length === 8) {
            searchCEP(value);
        }
    });
    
    // ========================================
    // AUTOCOMPLETE DE CEP
    // ========================================
    
    // Função para buscar CEP
    function searchCEP(cep) {
        // Remove caracteres não numéricos
        var cleanCEP = cep.replace(/\D/g, '');
        
        // Validação básica
        if (cleanCEP.length !== 8) {
            return;
        }
        
        console.log('Buscando CEP:', cleanCEP);
        
        // Mostrar loading no campo CEP
        $('#service_postalcode').parent().addClass('loading');
        
        // Desabilitar campos temporariamente
        $('#service_address, #service_district, #service_city').prop('readonly', true);
        
        // Buscar na API ViaCEP
        $.ajax({
            url: 'https://viacep.com.br/ws/' + cleanCEP + '/json/',
            method: 'GET',
            dataType: 'json',
            success: function(data) {
                console.log('Dados do CEP recebidos:', data);
                
                // Remover loading
                $('#service_postalcode').parent().removeClass('loading');
                
                // Habilitar campos
                $('#service_address, #service_district, #service_city').prop('readonly', false);
                
                // Verificar se o CEP é válido
                if (!data.erro) {
                    // Preencher campos com dados do CEP
                    fillAddressFromCEP(data);
                    
                    // Mostrar mensagem de sucesso
                    showCEPMessage('success', 'Endereço encontrado! Complete com o número.');
                    
                    // Focar no campo número
                    $('#service_number').focus();
                } else {
                    // CEP não encontrado
                    showCEPMessage('warning', 'CEP não encontrado. Verifique o número digitado.');
                }
            },
            error: function() {
                console.error('Erro ao buscar CEP');
                
                // Remover loading
                $('#service_postalcode').parent().removeClass('loading');
                
                // Habilitar campos
                $('#service_address, #service_district, #service_city').prop('readonly', false);
                
                // Mostrar mensagem de erro
                showCEPMessage('error', 'Erro ao buscar CEP. Tente novamente.');
            }
        });
    }
    
    // Função para preencher endereço com dados do CEP
    function fillAddressFromCEP(cepData) {
        // Preencher logradouro
        if (cepData.logradouro) {
            $('#service_address').val(cepData.logradouro);
        }
        
        // Preencher bairro
        if (cepData.bairro) {
            $('#service_district').val(cepData.bairro);
        }
        
        // Preencher cidade
        if (cepData.localidade) {
            var cidade = cepData.localidade;
            // Se tiver UF, adicionar
            if (cepData.uf) {
                cidade += ' - ' + cepData.uf;
            }
            $('#service_city').val(cidade);
        }
        
        // Preencher complemento se vier da API (raro)
        if (cepData.complemento && !$('#service_complement').val()) {
            $('#service_complement').val(cepData.complemento);
        }
        
        // Limpar o número (usuário precisa preencher)
        if (!$('#service_number').val()) {
            $('#service_number').val('');
        }
        
        // Adicionar classe de sucesso nos campos preenchidos
        $('#service_address, #service_district, #service_city').each(function() {
            if ($(this).val()) {
                $(this).parent().addClass('success');
                
                // Remover classe success após 3 segundos
                setTimeout(function() {
                    $('#service_address, #service_district, #service_city').parent().removeClass('success');
                }, 3000);
            }
        });
    }
    
    // Função para mostrar mensagem sobre o CEP
    function showCEPMessage(type, message) {
        // Remover mensagem anterior se existir
        $('#cep_message').remove();
        
        var iconClass = '';
        var messageClass = '';
        
        switch(type) {
            case 'success':
                iconClass = 'check circle';
                messageClass = 'positive';
                break;
            case 'warning':
                iconClass = 'warning sign';
                messageClass = 'warning';
                break;
            case 'error':
                iconClass = 'times circle';
                messageClass = 'negative';
                break;
        }
        
        var messageHtml = 
            '<div id="cep_message" class="ui ' + messageClass + ' message" style="margin-top: 10px;">' +
            '  <i class="' + iconClass + ' icon"></i>' +
            '  ' + message +
            '</div>';
        
        // Adicionar mensagem após o campo CEP
        $('#service_postalcode').closest('.field').after(messageHtml);
        
        // Auto remover mensagem após 5 segundos
        setTimeout(function() {
            $('#cep_message').transition('fade');
            setTimeout(function() {
                $('#cep_message').remove();
            }, 500);
        }, 5000);
    }
    
    // Adicionar botão de busca manual de CEP (opcional)
    $('#service_postalcode').parent().after(
        '<div class="ui tiny basic button" id="search_cep_btn" style="margin-top: 5px; display: none;">' +
        '  <i class="search icon"></i>' +
        '  Buscar CEP' +
        '</div>'
    );
    
    // Mostrar botão de busca quando tiver 8 dígitos
    $('#service_postalcode').on('input', function() {
        var cleanValue = $(this).val().replace(/\D/g, '');
        if (cleanValue.length === 8) {
            $('#search_cep_btn').show();
        } else {
            $('#search_cep_btn').hide();
            $('#cep_message').remove();
        }
    });
    
    // Evento do botão de busca manual
    $('#search_cep_btn').on('click', function() {
        var cep = $('#service_postalcode').val();
        if (cep) {
            searchCEP(cep);
        }
    });
    
    // Configurar tooltip de ajuda no CEP
    $('#service_postalcode').parent().parent().find('.info.icon').attr({
        'data-content': 'Digite o CEP para buscar o endereço automaticamente',
        'data-variation': 'tiny'
    }).popup();
    
    // Validação para aceitar apenas números no CEP
    $('#service_postalcode').on('keypress', function(e) {
        // Permitir apenas números, backspace, delete e hífen
        var charCode = e.which || e.keyCode;
        if (charCode !== 8 && charCode !== 46 && charCode !== 45 && (charCode < 48 || charCode > 57)) {
            e.preventDefault();
            return false;
        }
    });
    
    // ========================================
    // LÓGICA DE NEGÓCIO PARA TIPOS DE SERVIÇO
    // ========================================
    
    // Função para analisar o estado do veículo
    function analyzeVehicleState(vehicle) {
        var state = {
            hasMainTracker: false,
            hasBackupTracker: false,
            hasVideoTelemetry: false,
            hasAccessories: false,
            isBlocked: vehicle.blocked === true || vehicle.blocked === 't'
        };
        
        // Analisar equipamentos instalados
        if (vehicle.equipments && vehicle.equipments.length > 0) {
            vehicle.equipments.forEach(function(equipment) {
                // Rastreador principal
                if (equipment.main === true || equipment.main === 't') {
                    state.hasMainTracker = true;
                }
                // Rastreador contingência
                else if (equipment.main === false || equipment.main === 'f') {
                    state.hasBackupTracker = true;
                }
                
                // VideoTelemetria (verificar por tipo ou modelo)
                if (equipment.type === 'videotelemetry' || 
                    (equipment.equipmentmodelname && equipment.equipmentmodelname.toLowerCase().includes('video'))) {
                    state.hasVideoTelemetry = true;
                }
                
                // Acessórios
                if (equipment.hasblocking || equipment.hasibutton || equipment.hassiren || equipment.panicbuttonsite) {
                    state.hasAccessories = true;
                }
            });
        } else if (vehicle.inuse) {
            // Se marca como tendo rastreador mas não temos detalhes
            state.hasMainTracker = true;
        }
        
        console.log('Estado do veículo analisado:', state);
        return state;
    }
    
    // Função para obter serviços disponíveis baseado no estado
    function getAvailableServices(vehicleState) {
        var services = [];
        
        // REGRAS PARA RASTREADOR PRINCIPAL
        if (!vehicleState.hasMainTracker) {
            services.push({
                value: 'install_main_tracker',
                text: '🔧 Instalação de Rastreador Principal',
                category: 'tracker',
                priority: 1,
                info: 'Instalação de primeiro rastreador no veículo'
            });
        } else {
            services.push(
                {
                    value: 'maintenance_main_tracker',
                    text: '🔨 Manutenção de Rastreador Principal',
                    category: 'tracker',
                    priority: 2,
                    info: 'Verificação e reparo do rastreador principal'
                },
                {
                    value: 'remove_main_tracker',
                    text: '❌ Retirada de Rastreador Principal',
                    category: 'tracker',
                    priority: 5,
                    info: 'Remoção completa do rastreador principal'
                }
            );
        }
        
        // REGRAS PARA RASTREADOR CONTINGÊNCIA
        if (vehicleState.hasMainTracker && !vehicleState.hasBackupTracker) {
            services.push({
                value: 'install_backup_tracker',
                text: '🔧 Instalação de Rastreador Contingência',
                category: 'tracker',
                priority: 3,
                info: 'Instalação de rastreador de backup para redundância'
            });
        } else if (vehicleState.hasBackupTracker) {
            services.push(
                {
                    value: 'maintenance_backup_tracker',
                    text: '🔨 Manutenção de Rastreador Contingência',
                    category: 'tracker',
                    priority: 4,
                    info: 'Verificação e reparo do rastreador de contingência'
                },
                {
                    value: 'remove_backup_tracker',
                    text: '❌ Retirada de Rastreador Contingência',
                    category: 'tracker',
                    priority: 6,
                    info: 'Remoção do rastreador de contingência'
                }
            );
        }
        
        // REGRAS PARA VIDEOTELEMETRIA
        if (vehicleState.hasMainTracker) {
            if (!vehicleState.hasVideoTelemetry) {
                services.push({
                    value: 'install_videotelemetry',
                    text: '📹 Instalação de VideoTelemetria',
                    category: 'video',
                    priority: 7,
                    info: 'Instalação de sistema de câmeras e telemetria'
                });
            } else {
                services.push(
                    {
                        value: 'maintenance_videotelemetry',
                        text: '🔧 Manutenção de VideoTelemetria',
                        category: 'video',
                        priority: 8,
                        info: 'Verificação e ajuste do sistema de vídeo'
                    },
                    {
                        value: 'remove_videotelemetry',
                        text: '❌ Retirada de VideoTelemetria',
                        category: 'video',
                        priority: 9,
                        info: 'Remoção do sistema de videotelemetria'
                    }
                );
            }
        }
        
        // REGRAS PARA ACESSÓRIOS
        if (vehicleState.hasMainTracker || vehicleState.hasBackupTracker) {
            services.push({
                value: 'install_accessory',
                text: '➕ Instalação de Acessório',
                category: 'accessory',
                priority: 10,
                info: 'Instalação de bloqueador, sirene, botão de pânico, etc.'
            });
            
            if (vehicleState.hasAccessories) {
                services.push({
                    value: 'maintenance_accessory',
                    text: '🔧 Manutenção de Acessório',
                    category: 'accessory',
                    priority: 11,
                    info: 'Reparo ou ajuste de acessórios instalados'
                });
            }
        }
        
        // SERVIÇOS SEMPRE DISPONÍVEIS
        // Emergência com destaque se veículo está bloqueado
        if (vehicleState.isBlocked) {
            services.push({
                value: 'emergency',
                text: '🚨 EMERGÊNCIA - Veículo Bloqueado',
                category: 'general',
                priority: 0, // Máxima prioridade
                info: 'Desbloqueio de emergência - veículo atualmente bloqueado',
                highlight: true
            });
        } else {
            services.push({
                value: 'emergency',
                text: '🚨 Emergência',
                category: 'general',
                priority: 12,
                info: 'Atendimento de emergência (desbloqueio, pane, etc.)'
            });
        }
        
        services.push({
            value: 'inspection',
            text: '🔍 Vistoria',
            category: 'general',
            priority: 13,
            info: 'Vistoria geral do veículo e equipamentos'
        });
        
        // Ordenar por prioridade
        return services.sort(function(a, b) {
            return a.priority - b.priority;
        });
    }
    
    // Função para atualizar dropdown de tipos de serviço
    function updateServiceTypes(vehicle) {
        console.log('Atualizando tipos de serviço para o veículo:', vehicle.plate);
        
        // Analisar estado do veículo
        var vehicleState = analyzeVehicleState(vehicle);
        
        // Obter serviços disponíveis
        var availableServices = getAvailableServices(vehicleState);
        
        // Limpar dropdown atual
        var $serviceDropdown = $('#service_type');
        $serviceDropdown.empty();
        
        // Adicionar opção padrão
        $serviceDropdown.append('<option value="">Selecione o tipo de serviço</option>');
        
        // Agrupar serviços por categoria
        var categories = {
            'tracker': '🛰️ Rastreador',
            'video': '📹 VideoTelemetria',
            'accessory': '⚙️ Acessórios',
            'general': '📋 Serviços Gerais'
        };
        
        // Organizar serviços por categoria
        var servicesByCategory = {};
        availableServices.forEach(function(service) {
            if (!servicesByCategory[service.category]) {
                servicesByCategory[service.category] = [];
            }
            servicesByCategory[service.category].push(service);
        });
        
        // Adicionar serviços ao dropdown
        Object.keys(servicesByCategory).forEach(function(category) {
            // Adicionar grupo de opções
            var $optgroup = $('<optgroup label="' + categories[category] + '">');
            
            servicesByCategory[category].forEach(function(service) {
                var $option = $('<option value="' + service.value + '">' + service.text + '</option>');
                
                // Adicionar atributos de dados
                $option.attr('data-info', service.info);
                $option.attr('data-category', service.category);
                
                // Destacar emergência se necessário
                if (service.highlight) {
                    $option.addClass('emergency-highlight');
                    $option.css('color', '#d01919');
                    $option.css('font-weight', 'bold');
                }
                
                $optgroup.append($option);
            });
            
            $serviceDropdown.append($optgroup);
        });
        
        // Reinicializar dropdown do Semantic UI
        $serviceDropdown.dropdown('refresh');
        
        // Adicionar listener para mostrar info do serviço
        $serviceDropdown.on('change', function() {
            var selectedOption = $(this).find('option:selected');
            var info = selectedOption.attr('data-info');
            
            if (info) {
                $('#service_info_text').text(info);
                $('#service_info_message').show();
            } else {
                $('#service_info_message').hide();
            }
        });
        
        console.log('Tipos de serviço atualizados:', availableServices.length + ' opções disponíveis');
    }
    
    // Função para resetar tipos de serviço
    function resetServiceTypes() {
        console.log('Resetando tipos de serviço');
        
        var $serviceDropdown = $('#service_type');
        $serviceDropdown.empty();
        $serviceDropdown.append('<option value="">Selecione primeiro um veículo para ver serviços disponíveis</option>');
        $serviceDropdown.dropdown('refresh');
        
        $('#service_info_message').hide();
    }
    
    // ========================================
    // MONITORAMENTO DO CAMPO CLIENTE
    // ========================================
    
    $('#customer_name').on('input', function() {
        var value = $(this).val();
        
        // Se o campo foi limpo manualmente
        if (!value || value.trim() === '') {
            // Resetar seleção de cliente
            $('#customer_id').val('');
            $('#subsidiary_id').val('');
            $('#customer_details').removeClass('active');
            
            // Desabilitar campo de placa
            customerSelected = false;
            currentCustomerId = '';
            disablePlateField();
            
            // Limpar veículo
            $('#plate').val('');
            $('#plateid').val('');
            hideVehicleDetails();
            allVehicles = [];
            
            // Desabilitar e resetar tipos de serviço
            $('#service_type').parent().addClass('disabled');
            resetServiceTypes();
        }
    });
    
    // ========================================
    // CONFIGURAÇÃO DO CALENDÁRIO
    // ========================================
    
    $('#schedule_calendar').calendar({
        type: 'date',
        monthFirst: false,
        today: true,
        minDate: new Date(),
        // Tradução para português
        text: {
            days: ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'],
            months: ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 
                    'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'],
            monthsShort: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 
                         'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'],
            today: 'Hoje',
            now: 'Agora',
            am: 'AM',
            pm: 'PM'
        },
        formatter: { 
            date: function (date, settings) { 
                if (!date) return ''; 
                var day = date.getDate(); 
                var month = date.getMonth() + 1; 
                var year = date.getFullYear(); 
                return (day < 10 ? '0' : '') + day + '/' + 
                       (month < 10 ? '0' : '') + month + '/' + year; 
            }
        }
    });
    
    // ========================================
    // CONTROLE DE TIPO DE AGENDAMENTO
    // ========================================
    
    // Inicializar dropdown de período
    $('#scheduled_period').dropdown();
    
    // Eventos dos botões de tipo de agendamento
    $('#schedule_type_time').on('click', function() {
        if (!$(this).hasClass('active')) {
            $(this).addClass('active');
            $('#schedule_type_period').removeClass('active');
            
            // Mostrar seleção de horário
            $('#time_selection_container').show();
            $('#period_selection_container').hide();
            
            // Atualizar campo hidden
            $('#schedule_type').val('time');
            
            // Limpar seleção de período
            $('#scheduled_period').dropdown('clear');
        }
    });
    
    $('#schedule_type_period').on('click', function() {
        if (!$(this).hasClass('active')) {
            $(this).addClass('active');
            $('#schedule_type_time').removeClass('active');
            
            // Mostrar seleção de período
            $('#period_selection_container').show();
            $('#time_selection_container').hide();
            
            // Atualizar campo hidden
            $('#schedule_type').val('period');
            
            // Limpar seleção de horário
            $('#scheduled_time').dropdown('clear');
        }
    });
    
    // Verificar valor inicial (em caso de edição)
    if ($('#schedule_type').val() === 'period') {
        $('#schedule_type_period').trigger('click');
    }
    
    // ========================================
    // VALIDAÇÃO DO FORMULÁRIO
    // ========================================
    
    $('#appointmentForm').on('submit', function(e) {
        var date = $('#scheduled_date').val();
        var scheduleType = $('#schedule_type').val();
        var time = '';
        
        // Validar se cliente foi selecionado
        if (!$('#customer_id').val()) {
            e.preventDefault();
            alert('Por favor, selecione um cliente válido.');
            $('#customer_name').focus();
            return false;
        }
        
        // Validar se veículo foi selecionado
        if (!$('#plateid').val() && $('#plate').val()) {
            e.preventDefault();
            alert('Por favor, selecione um veículo válido da lista.');
            $('#plate').focus();
            return false;
        }
        
        // Validar data
        if (!date) {
            e.preventDefault();
            alert('Por favor, selecione uma data para o agendamento.');
            $('#scheduled_date').focus();
            return false;
        }
        
        // Validar horário ou período
        if (scheduleType === 'period') {
            var period = $('input[name="scheduled_period"]').val();
            if (!period) {
                e.preventDefault();
                alert('Por favor, selecione um período para o agendamento.');
                return false;
            }
            
            // Converter período em horário
            if (period === 'morning') {
                time = '08:00'; // Início do período da manhã
            } else if (period === 'afternoon') {
                time = '13:00'; // Início do período da tarde
            }
        } else {
            time = $('#scheduled_time').val();
            if (!time) {
                e.preventDefault();
                alert('Por favor, selecione um horário para o agendamento.');
                $('#scheduled_time').dropdown('show');
                return false;
            }
        }
        
        // Combinar data e hora
        if (date && time) {
            var dateParts = date.split('/');
            if (dateParts.length === 3) {
                var datetime = dateParts[2] + '-' + dateParts[1] + '-' + 
                              dateParts[0] + ' ' + time + ':00';
                $('#scheduled_at').val(datetime);
            }
        }
        
        // Adicionar loading ao botão
        $('#save_button').addClass('loading').prop('disabled', true);
    });
    
    // ========================================
    // EVENTOS DOS BOTÕES
    // ========================================
    
    // Botão cancelar
    $('#cancel_button').on('click', function() {
        if (confirm('Tem certeza que deseja cancelar? Todas as informações serão perdidas.')) {
            window.location.href = '{{ path_for("ERP\\Appointments\\Calendar") }}';
        }
    });
    
    // Fechar mensagens
    $('.ui.message .close.icon').on('click', function() {
        $(this).closest('.message').transition('fade');
    });
});
  </script>
{% endblock %}